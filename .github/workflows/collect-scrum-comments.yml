name: Collect Daily Scrum Comments

on:
  schedule:
    # 매일 KST 09:10 (UTC 00:10)
    - cron: '10 0 * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  collect-and-create-issue:
    runs-on: ubuntu-latest
    permissions:
      discussions: read
      issues: write
    
    steps:
      - name: Get current date (KST)
        id: date
        run: |
          DATE=$(TZ=Asia/Seoul date +'%Y-%m-%d')
          echo "date=$DATE" >> $GITHUB_OUTPUT
      
      - name: Find Discussion and Collect Comments
        id: collect
        env:
          GH_TOKEN: ${{ secrets.DISCUSSION_TOKEN }}
        run: |
          TITLE="${{ steps.date.outputs.date }} - 데일리스크럼"
          
          # Discussion 찾기
          DISCUSSION_DATA=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                discussions(first: 20, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes {
                    id
                    number
                    title
                    comments(first: 100) {
                      nodes {
                        author {
                          login
                        }
                        body
                      }
                    }
                  }
                }
              }
            }
          ' -F owner="100-hours-a-week" -F repo="8-team-name-wiki")
          
          # Discussion 찾기 및 댓글 파싱
          ISSUE_BODY=$(echo "$DISCUSSION_DATA" | jq -r --arg title "$TITLE" '
            .data.repository.discussions.nodes[] |
            select(.title == $title) |
            "# Daily Scrum - " + $title + "\n\n" +
            (
              [.comments.nodes[] | 
                {
                  author: .author.login,
                  body: .body
                }
              ] |
              group_by(.author) |
              map(
                "## @" + .[0].author + "\n" +
                (map(.body) | join("\n"))
              ) |
              join("\n\n")
            )
          ')
          
          # 결과가 비어있는지 확인
          if [ -z "$ISSUE_BODY" ] || [ "$ISSUE_BODY" == "null" ]; then
            echo "no_discussion=true" >> $GITHUB_OUTPUT
            echo "Warning: Discussion not found for $TITLE"
          else
            echo "no_discussion=false" >> $GITHUB_OUTPUT
            # 멀티라인 출력을 위한 처리
            {
              echo 'body<<EOF'
              echo "$ISSUE_BODY"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi
      
      - name: Create Issue
        if: steps.collect.outputs.no_discussion == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "Daily Scrum Summary - ${{ steps.date.outputs.date }}" \
            --body "${{ steps.collect.outputs.body }}" \
            --label "daily-scrum"
      
      - name: No Discussion Found
        if: steps.collect.outputs.no_discussion == 'true'
        run: |
          echo "::warning::No discussion found with title '${{ steps.date.outputs.date }} - 데일리스크럼'"